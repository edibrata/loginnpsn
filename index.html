<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Generator Rapor Kokurikuler</title>
    <!-- CSS & FONT LIBRARIES (Digabungkan dari kedua file) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <!-- JS LIBRARIES (Digabungkan dari kedua file) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* Styling digabungkan dari kedua file */
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        /* Style untuk menyembunyikan spinner pada input number */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }
        .tab-button { transition: all 0.2s ease-in-out; }
        .tab-button:not(.tab-active):hover:not(:disabled) { background-color: #f0f9ff; color: #0284c7; }
        .tab-button:disabled { cursor: not-allowed; pointer-events: none; }
        .tab-active { border-color: #0284c7; background-color: #0284c7; color: white; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .tab-content { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Style lainnya dari file Gemini20.8 Edit Mahir.html... */
        .kegiatan-body { transition: max-height 0.5s ease-in-out, opacity 0.3s ease-in-out, padding 0.5s ease-in-out; overflow: hidden; max-height: 0; opacity: 0; padding-top: 0; padding-bottom: 0; }
        .kegiatan-body.open { max-height: 5000px; opacity: 1; padding-top: 1rem; padding-bottom: 1rem; }
        .toggle-icon { transition: transform 0.3s ease-in-out; }
        .tooltip-container { position: relative; display: inline-flex; align-items: center; }
        .tooltip { visibility: hidden; opacity: 0; transition: opacity 0.3s; position: absolute; top: 110%; left: 50%; transform: translateX(-50%); background-color: #1e293b; color: white; text-align: center; padding: 8px 12px; border-radius: 6px; z-index: 100; width: max-content; max-width: 300px; font-size: 0.8rem; font-weight: 500; white-space: normal; }
        .tooltip-left { left: 0; transform: translateX(0); }
        .tooltip-left::after { left: 20px; }
        .tooltip::after { content: ""; position: absolute; bottom: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: transparent transparent #1e293b transparent; }
        .tooltip-container:hover .tooltip, .tooltip-container:focus-within .tooltip { visibility: visible; opacity: 1; }
        .tooltip:empty { display: none; }
        .kriteria-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-top: 0.75rem; }
        .kriteria-input { width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.375rem; font-size: 0.75rem; line-height: 1.25; resize: vertical; }
        .kriteria-input::placeholder { color: #94a3b8; }
        .asesmen-table-sticky thead th { position: sticky; background-color: #f8fafc; text-align: center; vertical-align: middle; }
        .asesmen-table-sticky thead tr:nth-of-type(1) th { top: 0; z-index: 3; }
        .asesmen-table-sticky thead tr:nth-of-type(2) th { top: 45px; z-index: 2; }
        .asesmen-table-sticky thead th[rowspan="2"] { z-index: 4; }
        .asesmen-table-sticky .tooltip-container:hover, .asesmen-table-sticky .tooltip-container:focus-within { z-index: 20; }
        .murid-table-btn { background: none; border: none; cursor: pointer; padding: 0.25rem 0.5rem; border-radius: 0.25rem; transition: background-color 0.2s; }
        .murid-table-btn:hover { background-color: #e2e8f0; }
        .murid-table-btn:disabled { color: #cbd5e1; cursor: not-allowed; }
        .murid-table-btn:disabled:hover { background-color: transparent; }
        .identitas-section-header { cursor: pointer; transition: background-color 0.2s; }
        .identitas-section-header:hover { background-color: #f1f5f9; }
        .identitas-section-body { transition: max-height 0.5s ease-in-out, opacity 0.3s ease-in-out, padding 0.5s ease-in-out, margin 0.5s ease-in-out; overflow: hidden; max-height: 0; opacity: 0; padding-top: 0; padding-bottom: 0; margin-top: 0; }
        .identitas-section-body.open { max-height: 1500px; opacity: 1; padding-top: 1.25rem; padding-bottom: 1.25rem; margin-top: -1px; }
        .identitas-toggle-icon { transition: transform 0.3s ease-in-out; }
        @media (max-width: 768px) { #tab-nav { grid-template-columns: repeat(3, 1fr); } #tab-nav .tab-wrapper:nth-child(4), #tab-nav .tab-wrapper:nth-child(5) { grid-column: span 1 / span 1; } #tab-nav .tab-wrapper:nth-child(4) { grid-column-start: 1; } #tab-nav .tab-wrapper:nth-child(5) { grid-column-start: 2; grid-column-end: 4; } .kriteria-grid { grid-template-columns: repeat(1, 1fr); } .perancangan-toolbar, .asesmen-toolbar { flex-direction: column; align-items: stretch; } .perancangan-toolbar > div, .asesmen-toolbar > div { justify-content: center; width: 100%; } }
        @media (max-width: 480px) { #tab-nav { grid-template-columns: repeat(2, 1fr); } #tab-nav .tab-wrapper:nth-child(n) { grid-column: auto; } .text-3xl { font-size: 1.5rem; } }
    </style>
</head>

<body>
    <!-- =================================================================== -->
    <!-- VIEW 1: HALAMAN LOGIN (Awalnya terlihat) -->
    <!-- =================================================================== -->
    <div id="login-view" class="min-h-screen bg-gradient-to-br from-sky-100 to-gray-50 flex items-center justify-center p-4">
        <!-- Kartu Login Utama -->
        <div class="bg-white w-full max-w-md p-8 md:p-10 rounded-2xl shadow-2xl transition-all">
            <div class="text-center">
                <h2 class="text-2xl font-bold text-sky-700 mb-2">Login Generator Kokurikuler</h2>
                <p class="text-sm text-gray-500 mb-6">Masukkan kode NPSN sekolah Anda untuk melanjutkan.</p>
            </div>

            <!-- Form Input -->
            <div class="space-y-4">
                <div>
                    <label for="npsn" class="sr-only">NPSN</label>
                    <input type="number" id="npsn" placeholder="Masukkan NPSN" class="w-full px-4 py-3 rounded-lg border border-gray-300 text-gray-700 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-transparent transition text-center" />
                </div>
                <button id="loginButton" class="w-full bg-sky-600 text-white font-semibold py-3 rounded-lg transition-all duration-300 ease-in-out hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2">
                    <svg id="button-spinner" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <svg id="button-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M6 3.5a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5-.5h-8a.5.5 0 0 1-.5-.5v-2a.5.5 0 0 0-1 0v2A1.5 1.5 0 0 0 6.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2h-8A1.5 1.5 0 0 0 5 3.5v2a.5.5 0 0 0 1 0v-2z" /><path fill-rule="evenodd" d="M11.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 1 0-.708.708L10.293 7.5H1.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z" /></svg>
                    <span id="button-text">Masuk</span>
                </button>
            </div>

            <!-- Footnote -->
            <div class="text-center mt-6">
                <p class="text-xs text-gray-400">&copy;2025 Edi Brata</p>
            </div>
        </div>

        <!-- Modal Notifikasi Login -->
        <div id="login-modal-container" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 transition-opacity duration-300 ease-out opacity-0 hidden">
            <div id="login-modal-panel" class="bg-white w-full max-w-md p-6 rounded-2xl shadow-xl transform transition-all duration-300 ease-out opacity-0 scale-95 relative">
                <div class="flex flex-col items-center text-center -mt-2 mb-4">
                    <div id="login-modal-icon-success" class="hidden bg-green-50 p-3 rounded-full mb-4"><svg class="w-10 h-10 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></div>
                    <div id="login-modal-icon-error" class="hidden bg-red-50 p-3 rounded-full mb-4"><svg class="w-10 h-10 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></div>
                    <h3 id="login-modal-title" class="text-lg font-semibold text-gray-900">Notifikasi</h3>
                </div>
                <div id="login-modal-content-body" class="text-sm text-gray-600 text-center space-y-2"><p>Konten modal akan muncul di sini.</p></div>
                <div class="mt-6 flex flex-col items-center space-y-3">
                    <a id="whatsapp-button" href="https://wa.me/6287773949015?text=Pa%20Edi%2C%20Saya%20ingin%20mendaftarkan%20sekolah%20saya%20karena%20NPSN%20belum%20terdaftar." target="_blank" class="hidden w-full px-6 py-3 bg-green-500 text-white font-medium rounded-lg hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition flex items-center justify-center space-x-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="w-5 h-5" viewBox="0 0 16 16"><path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.626-2.957 6.584-6.591 6.584zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z" /></svg><span>Hubungi via WhatsApp</span></a>
                    <button id="close-login-modal-button" class="w-full px-6 py-3 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-2 transition">Kembali</button>
                </div>
            </div>
        </div>
    </div>

    <!-- =================================================================== -->
    <!-- VIEW 2: APLIKASI UTAMA (Awalnya tersembunyi) -->
    <!-- =================================================================== -->
    <div id="app-view" class="hidden">
        <main class="bg-white rounded-xl shadow-lg border border-slate-200">
            <!-- Header dari file Gemini20.8 -->
            <header class="text-center relative bg-gradient-to-b from-white to-slate-50 pb-8 pt-6 border-b rounded-t-xl">
                <h1 class="text-3xl md:text-4xl font-bold text-sky-800 tracking-tight">Generator Kegiatan Kokurikuler</h1>
                <p class="mt-2 text-sm text-slate-500 max-w-2xl mx-auto">Aplikasi Generator Deskripsi Kegiatan Kokurikuler<br>Copyright © 2025 Edi Brata • Professional Edition • Versi 1.0 built 20250901</p>
                <div class="absolute top-4 right-4 flex gap-2">
                     <div class="tooltip-container">
                        <button id="backup-btn" aria-label="Backup Data" class="w-9 h-9 flex items-center justify-center bg-slate-100 hover:bg-slate-200 rounded-full text-slate-600 transition-colors"><i class="fas fa-download"></i></button>
                        <span class="tooltip" role="tooltip">Backup</span>
                    </div>
                    <div class="tooltip-container">
                        <button id="restore-btn" aria-label="Restore Data" class="w-9 h-9 flex items-center justify-center bg-slate-100 hover:bg-slate-200 rounded-full text-slate-600 transition-colors"><i class="fas fa-upload"></i></button>
                        <span class="tooltip" role="tooltip">Restore</span>
                    </div>
                    <input type="file" id="restore-file-input" class="hidden" accept=".json">
                    <div class="tooltip-container">
                        <button id="panduan-btn" aria-label="Buka Petunjuk" class="w-9 h-9 flex items-center justify-center bg-slate-100 hover:bg-slate-200 rounded-full text-slate-600 transition-colors"><i class="fas fa-question"></i></button>
                        <span class="tooltip" role="tooltip">Petunjuk</span>
                    </div>
                     <div class="tooltip-container">
                        <button id="profil-btn" aria-label="Buka Profil Pengembang" class="w-9 h-9 flex items-center justify-center bg-slate-100 hover:bg-slate-200 rounded-full text-slate-600 transition-colors"><i class="fas fa-user"></i></button>
                        <span class="tooltip" role="tooltip">Pengembang</span>
                    </div>
                </div>
            </header>

            <!-- Navigasi Tab dari file Gemini20.8 -->
            <div id="tab-nav" role="tablist" aria-label="Navigasi Utama" class="grid grid-cols-2 md:grid-cols-5 border-b border-slate-200 p-2 bg-slate-50">
                 <div class="tab-wrapper flex-1"><button id="tab-identitas" role="tab" aria-controls="identitas-content" aria-selected="true" data-tab="identitas" class="tab-button w-full flex-1 py-3 px-4 text-center text-sm md:text-base font-semibold rounded-lg"><i class="fas fa-id-card mr-2"></i>1. Identitas</button></div>
                <div class="tooltip-container tab-wrapper flex-1"><button id="tab-murid" role="tab" aria-controls="murid-content" aria-selected="false" tabindex="-1" data-tab="murid" class="tab-button w-full flex-1 py-3 px-4 text-center text-sm md:text-base font-semibold rounded-lg text-slate-500"><i class="fas fa-users mr-2"></i>2. Data Murid</button><span class="tooltip" role="tooltip"></span></div>
                <div class="tooltip-container tab-wrapper flex-1"><button id="tab-perancangan" role="tab" aria-controls="perancangan-content" aria-selected="false" tabindex="-1" data-tab="perancangan" class="tab-button w-full flex-1 py-3 px-4 text-center text-sm md:text-base font-semibold rounded-lg text-slate-500"><i class="fas fa-file-signature mr-2"></i>3. Perencanaan</button><span class="tooltip" role="tooltip"></span></div>
                <div class="tooltip-container tab-wrapper flex-1"><button id="tab-asesmen" role="tab" aria-controls="asesmen-content" aria-selected="false" tabindex="-1" data-tab="asesmen" class="tab-button w-full flex-1 py-3 px-4 text-center text-sm md:text-base font-semibold rounded-lg text-slate-500"><i class="fas fa-clipboard-check mr-2"></i>4. Asesmen</button><span class="tooltip" role="tooltip"></span></div>
                <div class="tooltip-container tab-wrapper flex-1"><button id="tab-hasil" role="tab" aria-controls="hasil-content" aria-selected="false" tabindex="-1" data-tab="hasil" class="tab-button w-full flex-1 py-3 px-4 text-center text-sm md:text-base font-semibold rounded-lg text-slate-500"><i class="fas fa-award mr-2"></i>5. Hasil Sintesis</button><span class="tooltip" role="tooltip"></span></div>
            </div>

            <!-- Konten Tab dari file Gemini20.8 -->
            <div class="p-6 md:p-8">
                <div id="identitas-content" role="tabpanel" aria-labelledby="tab-identitas" class="tab-content hidden"></div>
                <div id="murid-content" role="tabpanel" aria-labelledby="tab-murid" class="tab-content hidden"></div>
                <div id="perancangan-content" role="tabpanel" aria-labelledby="tab-perancangan" class="tab-content hidden">
                     <section id="perancangan">
                        <div class="perancangan-toolbar flex flex-wrap gap-2 justify-between items-center mb-6 border-b border-slate-200 pb-6">
                            <div class="flex flex-wrap gap-2">
                                <div class="tooltip-container"><button id="save-template-btn" class="inline-flex items-center justify-center px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-blue-700"><i class="fas fa-file-excel mr-2"></i>Template</button><span class="tooltip tooltip-left" role="tooltip">Unduh templat Excel kosong untuk merencanakan kegiatan</span></div>
                                <div class="tooltip-container"><button id="export-data-btn" class="inline-flex items-center justify-center px-4 py-2 bg-teal-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-teal-700"><i class="fas fa-file-export mr-2"></i>Ekspor</button><span class="tooltip tooltip-left" role="tooltip">Ekspor semua data perencanaan kegiatan ke file Excel</span></div>
                                <div class="tooltip-container"><button id="import-data-btn" class="inline-flex items-center justify-center px-4 py-2 bg-slate-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-slate-700"><i class="fas fa-file-import mr-2"></i>Impor</button><span class="tooltip tooltip-left" role="tooltip">Impor data perencanaan dari file templat Excel</span></div>
                                <input type="file" id="import-file-input" class="hidden" accept=".xlsx, .xls">
                                <div class="tooltip-container"><button id="clear-state-btn" class="inline-flex items-center justify-center px-4 py-2 bg-amber-500 text-white text-sm font-medium rounded-md shadow-sm hover:bg-amber-600"><i class="fas fa-undo mr-2"></i>Reset</button><span class="tooltip tooltip-left" role="tooltip">Hapus semua data Perencanaan dan Asesmen. Data Identitas dan Daftar Murid tidak akan terhapus.</span></div>
                                <div class="tooltip-container"><button id="undo-perancangan-btn" type="button" class="murid-table-btn text-slate-600" aria-label="Undo"><i class="fas fa-undo-alt"></i></button><span class="tooltip" role="tooltip">Batalkan (Undo)</span></div>
                                <div class="tooltip-container"><button id="redo-perancangan-btn" type="button" class="murid-table-btn text-slate-600" aria-label="Redo"><i class="fas fa-redo-alt"></i></button><span class="tooltip" role="tooltip">Ulangi (Redo)</span></div>
                            </div>
                            <div class="tooltip-container"><button id="tambah-kegiatan" class="inline-flex items-center px-4 py-2 bg-sky-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-sky-700"><i class="fas fa-plus mr-2"></i>Tambah</button><span class="tooltip" role="tooltip">Tambah kartu perencanaan kegiatan baru</span></div>
                        </div>
                        <div id="kegiatan-container" class="space-y-3"></div>
                    </section>
                </div>
                <div id="asesmen-content" role="tabpanel" aria-labelledby="tab-asesmen" class="tab-content hidden"></div>
                <div id="hasil-content" role="tabpanel" aria-labelledby="tab-hasil" class="tab-content hidden"></div>
            </div>
        </main>
    </div>

    <!-- SEMUA MODAL DARI FILE Gemini20.8 -->
    <!-- Help Modal, Profil Modal, Confirmation Modal, Notification Modal, Report Export Modal -->
    <div id="panduan-modal" role="dialog" aria-modal="true" aria-labelledby="panduan-title" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">... (Konten modal tidak diubah) ...</div>
    <div id="profil-modal" role="dialog" aria-modal="true" aria-labelledby="profil-title" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">... (Konten modal tidak diubah) ...</div>
    <div id="konfirmasi-modal" role="alertdialog" aria-modal="true" aria-labelledby="konfirmasi-title" aria-describedby="konfirmasi-message" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">... (Konten modal tidak diubah) ...</div>
    <div id="notifikasi-modal" role="alertdialog" aria-modal="true" aria-labelledby="notifikasi-message" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">... (Konten modal tidak diubah) ...</div>
    <div id="ekspor-laporan-modal" role="dialog" aria-modal="true" aria-labelledby="ekspor-laporan-title" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">... (Konten modal tidak diubah) ...</div>

    <!-- SEMUA TEMPLATE DARI FILE Gemini20.8 -->
    <template id="kegiatan-template">... (Konten template tidak diubah) ...</template>
    <template id="dimensi-template">... (Konten template tidak diubah) ...</template>
    <template id="subdimensi-item-template">... (Konten template tidak diubah) ...</template>

    <script>
    // --- BAGIAN 1: LOGIKA UNTUK LOGIN ---
    // Variabel global untuk menyimpan data sekolah setelah login berhasil
    let loggedInSchoolData = null;

    const npsnInput = document.getElementById("npsn");
    const loginButton = document.getElementById("loginButton");
    const buttonSpinner = document.getElementById("button-spinner");
    const buttonText = document.getElementById("button-text");
    const buttonIcon = document.getElementById("button-icon");
    
    // Fungsi-fungsi untuk modal login
    const loginModalContainer = document.getElementById("login-modal-container");
    const loginModalPanel = document.getElementById("login-modal-panel");
    const loginModalTitle = document.getElementById("login-modal-title");
    const loginModalContentBody = document.getElementById("login-modal-content-body");
    const loginModalIconSuccess = document.getElementById("login-modal-icon-success");
    const loginModalIconError = document.getElementById("login-modal-icon-error");
    const whatsappButton = document.getElementById("whatsapp-button");
    const closeLoginModalButton = document.getElementById("close-login-modal-button");

    function showLoginModal(title, contentHtml, type) {
        loginModalTitle.textContent = title;
        loginModalContentBody.innerHTML = contentHtml;
        loginModalIconSuccess.classList.add("hidden");
        loginModalIconError.classList.add("hidden");
        whatsappButton.classList.add("hidden");
        
        // Menghapus event listener lama agar tidak tereksekusi ganda
        const newButton = closeLoginModalButton.cloneNode(true);
        closeLoginModalButton.parentNode.replaceChild(newButton, closeLoginModalButton);

        if (type === "success") {
            loginModalIconSuccess.classList.remove("hidden");
            newButton.textContent = "Lanjut";
            // PERUBAHAN KUNCI: Saat sukses, tombol "Lanjut" akan memanggil fungsi startApp()
            newButton.addEventListener('click', startApp);
        } else {
            loginModalIconError.classList.remove("hidden");
            if (type === "error") whatsappButton.classList.remove("hidden");
            newButton.textContent = "Kembali";
            newButton.addEventListener('click', closeLoginModal);
        }

        loginModalContainer.classList.remove("hidden");
        setTimeout(() => {
            loginModalContainer.classList.remove("opacity-0");
            loginModalPanel.classList.remove("opacity-0", "scale-95");
        }, 10);
    }

    function closeLoginModal() {
        loginModalContainer.classList.add("opacity-0");
        loginModalPanel.classList.add("opacity-0", "scale-95");
        setTimeout(() => {
            loginModalContainer.classList.add("hidden");
        }, 300);
    }

    function setButtonLoading(isLoading) {
        loginButton.disabled = isLoading;
        buttonSpinner.classList.toggle("hidden", !isLoading);
        buttonIcon.classList.toggle("hidden", isLoading);
        buttonText.textContent = isLoading ? "Memeriksa..." : "Masuk";
    }
    
    // --- FUNGSI BARU: Untuk transisi dari login ke aplikasi utama ---
    function startApp() {
        if (!loggedInSchoolData) {
            alert("Terjadi kesalahan, data sekolah tidak ditemukan.");
            return;
        }

        // 1. Simpan NPSN ke sessionStorage untuk penanda sesi login
        sessionStorage.setItem('loggedInNPSN', loggedInSchoolData.npsn);
        
        // 2. Tutup modal login
        closeLoginModal();

        // 3. Sembunyikan view login dan tampilkan view aplikasi
        document.getElementById('login-view').classList.add('hidden');
        document.getElementById('app-view').classList.remove('hidden');
        
        // 4. Panggil fungsi init aplikasi utama dan kirim data sekolah
        initializeApp(loggedInSchoolData);
    }

    function prosesLogin() {
        const npsn = npsnInput.value.trim();
        if (!npsn) {
            showLoginModal("Input Tidak Valid", "<p>Silakan masukkan NPSN sekolah Anda.</p>", "info");
            return;
        }
        setButtonLoading(true);

        google.script.run
            .withSuccessHandler(function(result) {
                setButtonLoading(false);
                if (result.status === "success") {
                    // Simpan data sekolah ke variabel global
                    loggedInSchoolData = result.data;
                    loggedInSchoolData.npsn = npsn; // Tambahkan NPSN yang diinput ke data
                    
                    const successHtml = `
                        <p class="font-bold text-xl text-gray-900 mb-4">${result.data.namaSekolah}</p>
                        <div class="text-gray-600 text-sm text-left inline-block">
                          <p>NPSN: <span class="font-semibold text-gray-900">${npsn}</span></p>
                          <p>Kecamatan: <span class="font-semibold text-gray-900">${result.data.kecamatan}</span></p>
                          <p>Kabupaten: <span class="font-semibold text-gray-900">${result.data.kabupaten}</span></p>
                          <p>Provinsi: <span class="font-semibold text-gray-900">${result.data.provinsi}</span></p>
                        </div>`;
                    showLoginModal("Login Berhasil", successHtml, "success");
                } else {
                    const errorHtml = `<p>NPSN tidak ditemukan atau belum terdaftar.</p><p class="mt-2">Silakan hubungi pengembang untuk bantuan pendaftaran.</p>`;
                    showLoginModal("Login Gagal", errorHtml, "error");
                }
            })
            .withFailureHandler(function(error) {
                setButtonLoading(false);
                const errorHtml = `<p>Terjadi kesalahan saat menghubungi server. Silakan coba lagi nanti.</p><p class="mt-2 text-xs text-gray-400">Error: ${error.message}</p>`;
                showLoginModal("Error", errorHtml, "error");
            })
            .loginNPSN(npsn);
    }

    // Tambahkan event listener untuk tombol login
    loginButton.addEventListener('click', prosesLogin);
    npsnInput.addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            event.preventDefault();
            prosesLogin();
        }
    });

    // --- BAGIAN 2: LOGIKA APLIKASI UTAMA (Dari Gemini20.8) ---
    // Dibungkus dalam fungsi agar bisa dipanggil setelah login
    function initializeApp(schoolData) {
        document.addEventListener('DOMContentLoaded', () => {
             // Cek sesi saat halaman dimuat. Jika tidak ada sesi, jangan jalankan apa-apa.
             // Logika ini dipindahkan ke pengecekan awal sebelum memanggil initializeApp
        });

        // --- DATA & STATE --- (Semua variabel dari skrip Gemini20.8)
        let identitasData = {};
        // ... (semua variabel state lainnya) ...
        let kegiatanData = {};
        let muridData = {};
        let daftarMurid = []; 
        let muridHistory = [[]];
        let muridHistoryIndex = 0;
        let identitasHistory = [{}];
        let identitasHistoryIndex = 0;
        let perancanganHistory = [{}];
        let perancanganHistoryIndex = 0;
        let activeTab = 'identitas';
        let currentAsesmenViewId = null;
        let isIdentitasComplete = false;

        // --- DATA DIMENSI --- (Tidak diubah)
        const subdimensiDetail = { /* ... data subdimensi lengkap ... */ };
        // ... (variabel data lainnya)

        // --- DOM ELEMENTS --- (Tidak diubah)
        const DOMElements = { /* ... semua elemen DOM ... */ };

        // --- FUNGSI-FUNGSI APLIKASI (Dari Gemini20.8) ---
        // ... (semua fungsi seperti callGeminiAPI, saveState, loadState, openModal, dll.)

        // MODIFIKASI KUNCI: Fungsi renderIdentitasPage diubah untuk menerima data dari login
        const renderIdentitasPage = (prefillData = {}) => {
            // Gabungkan data yang sudah ada (dari localStorage) dengan data dari login
            identitasData = { ...identitasData, ...prefillData };

            const page = DOMElements.tabContents.identitas;
            const kelasOptions = Array.from({length: 12}, (_, i) => i + 1).map(k => `<option value="${k}" ${identitasData.kelas == k ? 'selected' : ''}>${k}</option>`).join('');
            const rombelOptionsList = ["Hanya Satu", ...Array.from({length: 15}, (_, i) => String.fromCharCode(65 + i))];
            const rombelOptions = rombelOptionsList.map(r => `<option value="${r}" ${identitasData.rombel == r ? 'selected' : ''}>${r}</option>`).join('');
            
            // Logika untuk menentukan pilihan dropdown dan mengunci input
            const isKabupaten = identitasData.kabupaten?.toLowerCase().includes('kab');
            const kabupatenKotaSelectVal = isKabupaten ? "Kabupaten" : "Kota";
            const namaKabupatenKotaVal = identitasData.kabupaten || '';

            const readonlyAttr = 'readonly class="bg-slate-200 cursor-not-allowed"';

            page.innerHTML = `
            <div class="max-w-4xl mx-auto space-y-4 text-gray-700 font-sans">
                <!-- ... Tombol-tombol di Tab Identitas ... -->
                <form id="identitas-form" class="space-y-4">
                    <!-- Satuan Pendidikan Accordion -->
                    <div class="border border-gray-300 rounded-md">
                        <div id="accordion-header-sekolah" ...>...</div>
                        <div id="accordion-body-sekolah" ...>
                            <!-- NAMA SEKOLAH (terkunci) -->
                            <input id="namaSekolah" name="namaSekolah" type="text" value="${identitasData.namaSekolah || ''}" ${readonlyAttr}/>
                            <!-- NPSN (terkunci) -->
                            <input id="npsn" name="npsn" type="text" value="${identitasData.npsn || ''}" ${readonlyAttr}/>
                            <!-- KECAMATAN (terkunci) -->
                            <input id="kecamatan" name="kecamatan" type="text" value="${identitasData.kecamatan || ''}" ${readonlyAttr}/>
                            <!-- KAB/KOTA (terkunci) -->
                            <select id="kabupatenKota" name="kabupatenKotaSelect" ${readonlyAttr}>
                                <option value="Kabupaten" ${kabupatenKotaSelectVal === 'Kabupaten' ? 'selected' : ''}>Kabupaten</option>
                                <option value="Kota" ${kabupatenKotaSelectVal === 'Kota' ? 'selected' : ''}>Kota</option>
                            </select>
                            <input id="namaKabupaten" name="namaKabupatenKota" type="text" value="${namaKabupatenKotaVal}" ${readonlyAttr}/>
                            <!-- PROVINSI (terkunci) -->
                            <input id="provinsi" name="provinsi" type="text" value="${identitasData.provinsi || ''}" ${readonlyAttr}/>

                            <!-- Input yang bisa diedit -->
                            <input id="alamat" name="alamat" type="text" value="${identitasData.alamat || ''}" .../>
                            <select id="desaKelurahan" name="desaKelurahanSelect" ...>...</select>
                            <input id="namaDesa" name="namaDesaKelurahan" type="text" value="${identitasData.namaDesaKelurahan || ''}" .../>
                        </div>
                    </div>
                    <!-- ... Accordion lainnya untuk Kelas, Guru, dll ... -->
                </form>
            </div>`;
            
            // ... sisa dari fungsi renderIdentitasPage tidak diubah ...
        };

        const init = (schoolDataOnInit) => {
            // Memuat state dari localStorage jika ada
            if (loadState()) {
                // Timpa data dari localStorage dengan data dari login (jika ada)
                identitasData = { ...identitasData, ...schoolDataOnInit };
            } else {
                identitasData = schoolDataOnInit;
            }

            // PERUBAHAN: Set isIdentitasComplete menjadi true jika data dari login ada,
            // karena data utama sudah valid.
            if(schoolDataOnInit && schoolDataOnInit.npsn){
                isIdentitasComplete = true; 
            }

            updateTabLockState();
            showTab('identitas');
            setupEventListeners();
        };
        
        // Panggil init dengan data dari login
        init(schoolData);
    }

    // --- BAGIAN 3: KONTROL SESI ---
    document.addEventListener('DOMContentLoaded', () => {
        const loggedInNPSN = sessionStorage.getItem('loggedInNPSN');
        if (loggedInNPSN) {
            // Jika ada sesi aktif (misalnya setelah refresh halaman),
            // coba login ulang secara otomatis di latar belakang untuk mendapatkan data terbaru.
            google.script.run.withSuccessHandler(function(result) {
                if (result.status === 'success') {
                    const reloadedSchoolData = result.data;
                    reloadedSchoolData.npsn = loggedInNPSN;
                    
                    document.getElementById('login-view').classList.add('hidden');
                    document.getElementById('app-view').classList.remove('hidden');
                    initializeApp(reloadedSchoolData);
                } else {
                    // Jika NPSN di sesi tidak valid lagi, hapus sesi dan tampilkan login
                    sessionStorage.removeItem('loggedInNPSN');
                    document.getElementById('login-view').classList.remove('hidden');
                    document.getElementById('app-view').classList.add('hidden');
                }
            }).loginNPSN(loggedInNPSN);
        } else {
            // Jika tidak ada sesi, pastikan view login yang terlihat.
            document.getElementById('login-view').classList.remove('hidden');
            document.getElementById('app-view').classList.add('hidden');
        }
    });

    </script>
</body>

</html>
